name: Build

on:
  push:
  pull_request:

jobs:
  build-linux:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    steps:
      - name: Set env
        run: |
          echo "LD_LIBRARY_PATH=/usr/local/lib" >> $GITHUB_ENV
          echo "STABLE_MOSH_PATH=mosh-0.2.8-rc3" >> $GITHUB_ENV
          echo "ONIGURUMA_PATH=onig-5.9.6" >> $GITHUB_ENV
      - name: Install tools
        run: |
          sudo apt update
          sudo apt install -y gauche wget make libgmp-dev autoconf automake golang-go
          sudo apt install -y re2c bison subversion git bear clang-tidy
      - name: Cache Oniguruma
        id: cache-oniguruma-linux
        uses: actions/cache@v3
        with:
          path: ${{ env.ONIGURUMA_PATH }}
          key: ${{ matrix.os }}-${{ env.ONIGURUMA_PATH }}
          restore-keys: ${{ matrix.os }}-${{ env.ONIGURUMA_PATH }}
      - name: Build Oniguruma
        if: steps.cache-oniguruma-linux.outputs.cache-hit != 'true'
        run: >
          wget https://github.com/kkos/oniguruma/releases/download/v5.9.6/onig-5.9.6.tar.gz &&
          tar zvxf onig-5.9.6.tar.gz &&
          cd $ONIGURUMA_PATH &&
          rm config.sub &&
          rm config.guess &&
          wget http://savannah.gnu.org/cgi-bin/viewcvs/*checkout*/config/config/config.guess &&
          wget http://savannah.gnu.org/cgi-bin/viewcvs/*checkout*/config/config/config.sub &&
          ./configure &&
          make
      - name: Install Oniguruma
        run: >
          cd $ONIGURUMA_PATH &&
          sudo make install
      - name: Cache Stable Mosh
        id: cache-stable-mosh-linux
        uses: actions/cache@v3
        with:
          path: ${{ env.STABLE_MOSH_PATH }}
          key: ${{ matrix.os }}-${{ env.STABLE_MOSH_PATH }}
          restore-keys: ${{ matrix.os }}-${{ env.STABLE_MOSH_PATH }}
      - name: Build Stable Mosh
        if: steps.cache-stable-mosh-linux.outputs.cache-hit != 'true'
        run: >
          wget https://github.com/higepon/mosh/releases/download/mosh-0.2.8-rc3/mosh-0.2.8-rc3.tar.gz &&
          tar zvxf mosh-0.2.8-rc3.tar.gz &&
          cd $STABLE_MOSH_PATH &&
          ./configure &&
          make &&
          make test
      - name: Install Stable Mosh
        run: >
          cd $STABLE_MOSH_PATH &&
          sudo make install
      - uses: actions/checkout@v3
        with:
          path: mosh-latest
      - name: Build and test the latest changes.
        run: >
          cd ${{ github.workspace }}/mosh-latest &&
          ./gen-git-build.sh &&
          ./configure &&
          make &&
          make test &&
          sudo make install
      - name: Run clang-tidy and treat warnings as error using bear 2.x.
        if: matrix.os == 'ubuntu-latest'
        run: >
          cd ${{ github.workspace }}/mosh-latest &&
          make clean &&
          bear --version &&
          bear --help &&
          bear --exclude src/ffi_stub_x86_64.S make &&
          run-clang-tidy -header-filter=src -quiet
      - name: Install jj so that we can edit compile_commands.json.
        if: matrix.os == 'ubuntu-22.04'
        run: >
          wget https://github.com/tidwall/jj/archive/refs/tags/v1.9.2.tar.gz &&
          tar zvxf v1.9.2.tar.gz &&
          cd jj-1.9.2/ &&
          make
      - name: Run clang-tidy and treat warnings as error using bear 3.x.
        if: matrix.os == 'ubuntu-22.04'
        run: >
          cd ${{ github.workspace }}/mosh-latest &&
          make clean &&
          bear --version &&
          bear --help &&
          bear -- make &&
          echo "Excluding .S file manually" &&
          mv compile_commands.json tmp.json &&
          jj -i tmp.json "#(file!="src/ffi_stub_x86_64.S")#" > compile_commands.json &&
          run-clang-tidy -header-filter=src -quiet &&

  build-macos:
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, macos-12]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    steps:
      - name: Set env
        run: |
          # Use homebrew bison instead of /usr/bin/bison
          echo "/usr/local/opt/bison/bin" >> $GITHUB_PATH
          # FIXME: Detect gnump with pkg-config
          echo "LDFLAGS=-L$HOMEBREW_PREFIX/lib" >> $GITHUB_ENV
          echo "CFLAGS=-I$HOMEBREW_PREFIX/include" >> $GITHUB_ENV
          echo "CXXFLAGS=-I$HOMEBREW_PREFIX/include" >> $GITHUB_ENV
          echo "STABLE_MOSH_PATH=mosh-0.2.8-rc3" >> $GITHUB_ENV
          # FIXME: Disable GC during CI for now
          echo "GC_DONT_GC=1" >> $GITHUB_ENV
      - name: Instlall tools
        run: |
          brew install gmp oniguruma automake re2c bison subversion gauche
      - name: Cache Stable Mosh
        id: cache-stable-mosh-macos
        uses: actions/cache@v3
        with:
          path: ${{ env.STABLE_MOSH_PATH }}
          key: ${{ matrix.os }}-${{ env.STABLE_MOSH_PATH }}
          restore-keys: ${{ matrix.os }}-${{ env.STABLE_MOSH_PATH }}
      - name: Build Stable Mosh
        if: steps.cache-stable-mosh-macos.outputs.cache-hit != 'true'
        run: >
          curl -OL https://github.com/higepon/mosh/releases/download/mosh-0.2.8-rc3/mosh-0.2.8-rc3.tar.gz &&
          tar zvxf mosh-0.2.8-rc3.tar.gz &&
          cd $STABLE_MOSH_PATH &&
          ./configure &&
          make &&
          make test
      - name: Install Stable Mosh
        run: >
          cd $STABLE_MOSH_PATH &&
          sudo make install
      - uses: actions/checkout@v3
        with:
          path: mosh-latest
      - name: Build and test the latest changes.
        run: >
          cd ${{ github.workspace }}/mosh-latest &&
          ./gen-git-build.sh &&
          ./configure &&
          make &&
          make test &&
          sudo make install
